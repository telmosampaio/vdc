{
    "Organization": "file(../_Common/organizationName.txt)",
    "DeploymentName": "aks",
    "InstanceName": "${Parameters.Organization}-${Parameters.DeploymentName}",
    "Subscription": "AKS",
    "ModuleConfigurationParameters": {
        "DeploymentUserId": "env(DEPLOYMENT_USER_ID)",
        "ResourceGroupPrefix": "${Parameters.Organization}-${Parameters.DeploymentName}",
        "Region": "westus2",
        "DnsPrefix": "aks",
        "SharedServices": {
            "DeploymentName": "shrdsvcs",
            "ActiveDirectory": {
                "VmIpAddressStart": [ "172.0.0.10" ]
            },
            "Network": {
                "Id": "/subscriptions/${Subscriptions.SharedServices.SubscriptionId}/resourceGroups/${Parameters.ModuleConfigurationParameters.SharedServices.Network.ResourceGroupName}/providers/Microsoft.Network/virtualNetworks/${Parameters.ModuleConfigurationParameters.SharedServices.Network.Name}",
                "Name": "${Parameters.Organization}-${Parameters.ModuleConfigurationParameters.SharedServices.DeploymentName}-vnet",
                "ResourceGroupName": "${Parameters.Organization}-${Parameters.ModuleConfigurationParameters.SharedServices.DeploymentName}-network-rg",
                "AddressPrefix": "10.4.0.32/27",
                "NetworkVirtualAppliance": {
                    "EgressIp": "10.4.1.4",
                    "AzureFirewall": {
                        "Name": "${Parameters.Organization}-${Parameters.ModuleConfigurationParameters.SharedServices.DeploymentName}-azfw"
                    }
                }
            }
        },
        "Workspace": {
            "Region": "westus",
            "Sku": "standalone"
        },
        "KeyVault": {
            "Name": "${Parameters.Organization}-${Parameters.DeploymentName}-kv",
            "ResourceGroup": "${Parameters.InstanceName}-keyvault-rg",
            "Sku": "Premium",
            "EnableVaultForDeployment": true,
            "EnableVaultForDiskEncryption": true,
            "EnableVaultForTemplateDeployment": true,
            "AccessPolicies": [],
            "SecretsObject": {
                "Comments": "Creating an object so we can use a secretsobject parameter type in our ARM template",
                "Secrets": [
                    {
                        "secretName": "admin-user",
                        "secretValue": ""
                    }
                ]
            },
            "NetworkAcls": {}
        },
        "DiagnosticStorageAccount": {
            "Name": "${Parameters.Organization}${Parameters.DeploymentName}diag01",
            "ResourceGroup": "${Parameters.InstanceName}-diagnostics-rg",
            "Location": "${Parameters.Location}",
            "Sku": "Standard_GRS",
            "NetworkAcls": {
                "bypass": "AzureServices",
                "defaultAction": "Deny",
                "virtualNetworkRules": [
                    {
                        "subnet": "${Parameters.ModuleConfigurationParameters.Network.Subnets[0].Name}"
                    }
                ],
                "ipRules": []
            },
            "Policies": {
                "Effect": "Audit"
            }
        },
        "SecurityCenter": {
            "ResourceGroup": "${Parameters.InstanceName}-diagnostics-rg",
            "Location": "${Parameters.Location}",
        },
        "Network": {
            "Name": "${Parameters.InstanceName}-vnet",
            "ResourceGroup": "${Parameters.InstanceName}-network-rg",
            "EnableDdosProtection": false,
            "EnableVmProtection": false,
            "AddressPrefixes": ["10.2.0.0/16"],
            "ApplicationSecurityGroups": [],
            "AzureFirewallNetworkRuleCollection": [
                {
                    "name": "aks-cluster-nrc-01",
                    "properties": {
                        "priority": "500",
                        "action": {
                            "type": "Allow"
                        },
                        "rules": [
                            {
                                "name": "allow-ssh-access",
                                "description": "Allows outbound SSH access",
                                "protocols": [
                                    "TCP"
                                ],
                                "sourceAddresses": [
                                    "${Parameters.ModuleConfigurationParameters.Network.Subnets[0].AddressPrefix}"
                                ],
                                "destinationAddresses": [
                                    "*"
                                ],
                                "destinationPorts": [
                                    "22"
                                ]
                            }
                        ]
                    }
                }
            ],
            "AzureFirewallApplicationRuleCollection": [
                {
                    "name": "aks-cluster-01",
                    "properties": {
                        "priority": 500,
                        "action": {
                            "type": "Allow"
                        },
                        "rules": [
                            {
                                "name": "cluster",
                                "protocols": [
                                    {
                                        "protocolType": "Http",
                                        "port": 80
                                    },
                                    {
                                        "protocolType": "Https",
                                        "port": 443
                                    }
                                ],
                                "fqdnTags": [],
                                "targetFqdns": [
                                    "*"
                                ],
                                "sourceAddresses": [
                                    "${Parameters.ModuleConfigurationParameters.Network.Subnets[0].AddressPrefix}"
                                ]
                            }
                        ]
                    }
                }
            ],
            "NetworkSecurityGroups": [
                {
                    "Name": "default",
                    "Rules": [
                        {
                            "Name": "allow-azure-loadbalancer",
                            "Properties": {
                                "Access": "Allow",
                                "DestinationAddressPrefixes": [],
                                "DestinationAddressPrefix": "VirtualNetwork",
                                "DestinationPortRange": "*",
                                "DestinationPortRanges":[],
                                "DestinationApplicationSecurityGroups": [],
                                "Direction": "Inbound",
                                "Priority": 100,
                                "Protocol": "*",
                                "SourcePortRange": "*",
                                "SourcePortRanges": [],
                                "SourceAddressPrefix": "AzureLoadBalancer",
                                "SourceApplicationSecurityGroups":[]
                            }
                        },
                        {
                            "Name": "allow-ssh",
                            "Properties": {
                                "Access": "Allow",
                                "DestinationAddressPrefixes": [],
                                "DestinationAddressPrefix": "VirtualNetwork",
                                "DestinationPortRange": "22",
                                "DestinationPortRanges": [],
                                "DestinationApplicationSecurityGroups": [],
                                "Direction": "Inbound",
                                "Priority": 110,
                                "Protocol": "Tcp",
                                "SourcePortRange": "*",
                                "SourcePortRanges": [],
                                "SourceAddressPrefix": "10.4.0.32/27",
                                "SourceApplicationSecurityGroups": []
                            }
                        },
                        {
                            "Name": "allow-http",
                            "Properties": {
                                "Access": "Allow",
                                "DestinationAddressPrefixes": [],
                                "DestinationAddressPrefix": "VirtualNetwork",
                                "DestinationPortRange": "80",
                                "DestinationPortRanges": [],
                                "DestinationApplicationSecurityGroups": [],
                                "Direction": "Inbound",
                                "Priority": 120,
                                "Protocol": "*",
                                "SourcePortRange": "*",
                                "SourcePortRanges": [],
                                "SourceAddressPrefix": "VirtualNetwork",
                                "SourceApplicationSecurityGroups": []
                            }
                        },
                        {
                            "Name": "allow-https",
                            "Properties": {
                                "Access": "Allow",
                                "DestinationAddressPrefixes": [],
                                "DestinationAddressPrefix": "VirtualNetwork",
                                "DestinationPortRange": "443",
                                "DestinationPortRanges": [],
                                "DestinationApplicationSecurityGroups": [],
                                "Direction": "Inbound",
                                "Priority": 130,
                                "Protocol": "*",
                                "SourcePortRange": "*",
                                "SourcePortRanges": [],
                                "SourceAddressPrefix": "VirtualNetwork",
                                "SourceApplicationSecurityGroups": []
                            }
                        },
                        {
                            "Name": "deny-internet",
                            "Properties": {
                                "Access": "Deny",
                                "DestinationAddressPrefix": "*",
                                "DestinationAddressPrefixes": [],
                                "DestinationPortRange": "*",
                                "DestinationPortRanges": [],
                                "DestinationApplicationSecurityGroups": [],
                                "Direction": "Inbound",
                                "Priority": 4095,
                                "Protocol": "Tcp",
                                "SourcePortRange": "*",
                                "SourcePortRanges": [],
                                "SourceAddressPrefix": "Internet",
                                "SourceApplicationSecurityGroups": []
                            }
                        },
                        {
                            "Name": "deny-vnet",
                            "Properties": {
                                "Access": "Deny",
                                "DestinationAddressPrefix": "VirtualNetwork",
                                "DestinationAddressPrefixes": [],
                                "DestinationPortRange": "*",
                                "DestinationPortRanges": [],
                                "DestinationApplicationSecurityGroups": [],
                                "Direction": "Inbound",
                                "Priority": 4096,
                                "Protocol": "Tcp",
                                "SourcePortRange": "*",
                                "SourcePortRanges": [],
                                "SourceAddressPrefix": "VirtualNetwork",
                                "SourceApplicationSecurityGroups": []
                            }
                        }
                    ]
                }
            ],
            "UserDefinedRoutes": [
                {
                    "Name": "default",
                    "Routes": [
                        {
                            "Name": "default",
                            "Properties": {
                                "AddressPrefix": "0.0.0.0/0",
                                "NextHopIpAddress": "172.0.3.4",
                                "NextHopType": "VirtualAppliance"
                            }
                        },
                        {
                            "Name": "to-on-premises",
                            "Properties": {
                                "AddressPrefix": "192.168.1.0/28",
                                "NextHopType": "VirtualNetworkGateway"
                            }
                        }
                    ]
                }
            ],
            "Subnets": [
                {
                    "name": "default",
                    "addressPrefix": "10.2.0.0/17",
                    "networkSecurityGroupName": "${Parameters.ModuleConfigurationParameters.Network.NetworkSecurityGroups[0].Name}",
                    "userDefinedRoute": "${Parameters.ModuleConfigurationParameters.Network.UserDefinedRoutes[0].Name}",
                    "routeTableName": "",
                    "serviceEndpoints": [
                        {
                            "Service": "Microsoft.EventHub"
                        },
                        {
                            "Service": "Microsoft.Sql"
                        },
                        {
                            "Service": "Microsoft.KeyVault"
                        },
                        {
                            "Service": "Microsoft.Storage"
                        }
                    ]
                }
            ],
            "DnsServers": "${Parameters.ModuleConfigurationParameters.SharedServices.ActiveDirectory.VmIpAddressStart}"
        },
        "Kubernetes": {
            "KubernetesVersion": "1.13.5",
            "ResourceGroup": "${Parameters.InstanceName}-aks-rg",
            "OsType": "Linux",
            "NetworkPlugin": "azure",
            "MaxPods": 30,
            "OsDiskSizeGb": 60,
            "AgentCount": 2,
            "AgentVmSize": "Standard_DS3_v2",
            "EnableRbac": true,
            "EnableHttpApplicationRouting": false,
            "EnableOmsAgent": true,
            "CaCertKeyName": "${Parameters.Organization}-${Parameters.DeploymentName}-ca",
            "CaName": "${Parameters.Organization}-${Parameters.DeploymentName}-ca",
            "ClusterName": "${Parameters.Organization}-${Parameters.DeploymentName}-k8s",
            "ClusterResourceGroupName": "${Parameters.Organization}-${Parameters.DeploymentName}-aks-rg",
            "TillerNamespace": "tiller",
            "ServicePrincipalClientId": "env(SERVICE_PRINCIPAL_CLIENT_ID)",
            "ServicePrincipalClientSecret": "env(SERVICE_PRINCIPAL_CLIENT_SECRET)",
            "RbacServerAppid": "env(RBAC_SERVER_APP_ID)",
            "RbacServerSecret": "env(RBAC_SERVER_SECRET)",
            "RbacClientAppId": "env(RBAC_CLIENT_APP_ID)",
            "RbacTenant": "env(RBAC_TENANT)",
            "ServiceCIDR": "10.0.0.0/16",
            "DnsServiceIp": "10.0.0.10",
            "DockerBridgeCIDR": "172.17.0.1/16",
            "AksClusterAdminRbacRoleId": "0ab0b1a8-8aac-4efd-b8c2-3ee1fb270be8",
            "AksClusterUserRbacRoleId": "4abbcc35-e782-43d8-92c5-2d3f1bd2253f",
            "ReaderRbacRoleId": "acdd72a7-3385-48ef-bd42-f606fba81ae7",
            "ClusterAdminGroupId": "6899b6cf-3f98-4e6a-9575-4551a388bc4c",
            "NocUserGroupId": "6f55a76f-29d7-468e-989e-bb18332deda7",
            "DevUserGroupId": "3c4d59df-feee-435f-b4ee-db35e9d410c4",
        },
        "Rbac": {
            "ResourceGroupAssignments": [
                {
                    "Comments": "Azure Service Cluster Admin Role - Use Admin Persona Principal Id",
                    "RoleDefinitionId": "${Parameters.ModuleConfigurationParameters.Kubernetes.AksClusterAdminRbacRoleId}",
                    "PrincipalId": "${Parameters.ModuleConfigurationParameters.Kubernetes.ClusterAdminGroupId}"
                },
                {
                    "Comments": "Azure Service Cluster User Role - Admin",
                    "RoleDefinitionId": "${Parameters.ModuleConfigurationParameters.Kubernetes.AksClusterUserRbacRoleid}",
                    "PrincipalId": "${Parameters.ModuleConfigurationParameters.Kubernetes.ClusterAdminGroupId}"
                },
                {
                    "Comments": "Azure Service Cluster User Role - NOC user",
                    "RoleDefinitionId": "${Parameters.ModuleConfigurationParameters.Kubernetes.AksClusterUserRbacRoleid}",
                    "PrincipalId": "${Parameters.ModuleConfigurationParameters.Kubernetes.NocUserGroupId}"
                },
                {
                    "Comments": "Azure Service Cluster User Role - Devs",
                    "RoleDefinitionId": "${Parameters.ModuleConfigurationParameters.Kubernetes.AksClusterUserRbacRoleid}",
                    "PrincipalId": "${Parameters.ModuleConfigurationParameters.Kubernetes.DevUserGroupId}"
                },
                {
                    "Comments": "Reader Role - Use Admin Persona Principal Id",
                    "RoleDefinitionId": "${Parameters.ModuleConfigurationParameters.Kubernetes.ReaderRbacRoleId}",
                    "PrincipalId": "${Parameters.ModuleConfigurationParameters.Kubernetes.ClusterAdminGroupId}"
                },
                {
                    "Comments": "Reader Role - Use Dev Persona Principal Id",
                    "RoleDefinitionId": "${Parameters.ModuleConfigurationParameters.Kubernetes.ReaderRbacRoleId}",
                    "PrincipalId": "${Parameters.ModuleConfigurationParameters.Kubernetes.DevUserGroupId}"
                },
                {
                    "Comments": "Reader Role - Use NOC Persona Principal Id",
                    "RoleDefinitionId": "${Parameters.ModuleConfigurationParameters.Kubernetes.ReaderRbacRoleId}",
                    "PrincipalId": "${Parameters.ModuleConfigurationParameters.Kubernetes.NocUserGroupId}"
                }
            ],
            "Comments": "aks-node-resource-group-assignments gets its assignment scope by grabbing a node resource group name from AKS deployment outputs",
            "AksNodeResourceGroupAssignments": [
                {
                    "Comments": "Reader Role - Use Admin Persona Principal Id",
                    "RoleDefinitionId": "${Parameters.ModuleConfigurationParameters.Kubernetes.ReaderRbacRoleId}",
                    "PrincipalId": "${Parameters.ModuleConfigurationParameters.Kubernetes.ClusterAdminGroupId}"
                },
                {
                    "Comments": "Reader Role - Use Dev Persona Principal Id",
                    "RoleDefinitionId": "${Parameters.ModuleConfigurationParameters.Kubernetes.ReaderRbacRoleId}",
                    "PrincipalId": "${Parameters.ModuleConfigurationParameters.Kubernetes.DevUserGroupId}"
                },
                {
                    "Comments": "Reader Role - Use NOC Persona Principal Id",
                    "RoleDefinitionId": "${Parameters.ModuleConfigurationParameters.Kubernetes.ReaderRbacRoleId}",
                    "PrincipalId": "${Parameters.ModuleConfigurationParameters.Kubernetes.NocUserGroupId}"
                }
            ]
        },
        "ACR": {
            "Name": "${Parameters.Organization}${Parameters.DeploymentName}acr",
            "ResourceGroup": "${Parameters.InstanceName}-acr-rg",
            "AdminUserEnabled": true,
            "Sku": "Standard"
        },
        "LogAnalytics": {
            "Name": "${Parameters.InstanceName}-la",
            "Comments": "Log Analytics and Diagnostic Storage Account must be deployed in the same region",
            "ResourceGroup": "${Parameters.InstanceName}-diagnostics-rg",
            "Location": "${Parameters.ModuleConfigurationParameters.DiagnosticStorageAccount.Location}",
            "ListOfAllowedRegions": [
                "Australia Central",
                "Australia East",
                "Australia Southeast",
                "Canada Central",
                "Central India",
                "Central US",
                "East Asia",
                "East US",
                "East US 2",
                "France Central",
                "Japan East",
                "Korea Central",
                "North Europe",
                "South Central US",
                "Southeast Asia",
                "UK South",
                "West Europe",
                "West US",
                "West US 2"
            ]
        },
        "AutomationAccount": {
            "Region": "westus"
        },
        "EventHub": {
            "ResourceGroup": "${Parameters.InstanceName}-diagnostics-rg",
            "Namespace": "${Parameters.Organization}eventhubnamespace",
            "Name": "${Parameters.Organization}-diagnostics-eventhub",
            "ConsumerGroupName": "${Parameters.Organization}eventconsumergroup1",
            "Sku": "Standard"
        },
        "Diagnostics": {
            "ResourceGroupName": "${Parameters.ModuleConfigurationParameters.ResourceGroupPrefix}-aks-diagnostics-rg",
            "Storage": {
                "Name": "${Parameters.Organization}diagnosticsstorage"
            },
            "LogAnalytics": {
                "Name": "${Parameters.ModuleConfigurationParameters.ResourceGroupPrefix}-diagnostics-la"
            }
        }
    }
}